# Case-study оптимизации

## 1 - Загрузка JSON в базу данных шаг 1
  Начал я с того что установил rspec и написал тесты для контроллера и рейк таски. Тест для рэйк таски все время проходил при любом времени обработки, наверное из за асинхронности рейка. Пришлось убрать ее в app и создать для нее класс там. С загрузкой json особо не мудрствовал, просто добавляя повторяющиеся объекты в массив получилось обработать большой файл за 2 минуты. Задействовал activerecord-import и сократив время обработки до 30 секунд и остановился на этом. В реальной жизни я бы на двух минутах остановился, ещё может быть и sleep воткнул между итерациями, чтобы на полчаса-час это растянуть. 

## 2 - Оптимизация TripsController#index шаг 1
  Итак, начинаме мы со следующего: консоль рельс: (Views: 9547.9ms | ActiveRecord: 1741.6ms) rack-mini-profiler показал что patrials тоже делают запросы. добавил preload (Views: 4093.9ms | ActiveRecord: 64.5ms). Потом я обратил внимание что ни в одном автобусе нет ни одного сервиса и посчитал эьто странным. Обнаружил что я Автобусы импортировал пачкой, а джойнеры нет, а в тесте я проверял только сами сервисы на наличие. Переделал DatabaseSeeder, прогнал тесты, убедился что все работает. Итак, результаты с Джойнерами на большом файле: до preload (Views: 25969.6ms | ActiveRecord: 2323.2ms), после (Views: 19946.3ms | ActiveRecord: 94.8ms). Запросов соответственно 5. Дальше я решил загрузить большие файлы, чтобы посмотреть насколько дальше можно сопримизировать БД

## 1 - Загрузка JSON в базу данных шаг 2
  Как делать загрузку в потоковом режиме вы описали в readme, я оттуда ее и скопировал. Удивило то что внутри блока нельзя делать никаких запросов к базе вообще. Даже City.new выдавал ошибку, наверное спрашивал про дефолтные значения. Интересно что произойдет если прочитать из базы попытается кто-то другой? 